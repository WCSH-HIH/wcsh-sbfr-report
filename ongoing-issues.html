<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ongoing Issues Tracker - SBFR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #fff 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(211, 47, 47, 0.3);
            margin-bottom: 30px;
            position: relative;
        }

        .nav-back {
            position: absolute;
            top: 50%;
            left: 30px;
            transform: translateY(-50%);
            z-index: 10;
        }

        .arrow-btn {
            background: linear-gradient(145deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-decoration: none;
        }

        .arrow-btn:hover {
            background: linear-gradient(145deg, rgba(255,255,255,0.5), rgba(255,255,255,0.3));
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1.1em;
            font-weight: 300;
            letter-spacing: 1px;
            opacity: 0.95;
        }

        .info-banner {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #ff6f00;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .info-banner h3 {
            color: #e65100;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .info-banner p {
            color: #666;
            line-height: 1.6;
            font-size: 1.05em;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 4px solid #1976d2;
        }

        .stat-card.high-priority {
            border-top-color: #d32f2f;
        }

        .stat-card.medium-priority {
            border-top-color: #ff6f00;
        }

        .stat-card.low-priority {
            border-top-color: #388e3c;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #1976d2;
            margin-bottom: 5px;
        }

        .stat-card.high-priority .stat-number {
            color: #d32f2f;
        }

        .stat-card.medium-priority .stat-number {
            color: #ff6f00;
        }

        .stat-card.low-priority .stat-number {
            color: #388e3c;
        }

        .stat-label {
            color: #666;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-divider {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin: 30px 0 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #7b1fa2;
        }

        .section-divider h2 {
            color: #7b1fa2;
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .issues-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .issue-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 6px solid #1976d2;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        .issue-card:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 30px rgba(0,0,0,0.15);
        }

        .issue-card.high {
            border-left-color: #d32f2f;
            background: linear-gradient(to right, #ffebee 0%, white 5%);
        }

        .issue-card.medium {
            border-left-color: #ff6f00;
            background: linear-gradient(to right, #fff3e0 0%, white 5%);
        }

        .issue-card.low {
            border-left-color: #388e3c;
            background: linear-gradient(to right, #e8f5e9 0%, white 5%);
        }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .issue-category {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-admin {
            background: linear-gradient(135deg, #ff6f00, #ff8f00);
            color: white;
        }

        .category-clinical {
            background: linear-gradient(135deg, #1976d2, #2196f3);
            color: white;
        }

        .category-nonclinical {
            background: linear-gradient(135deg, #388e3c, #4caf50);
            color: white;
        }

        .priority-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .priority-high {
            background: #d32f2f;
            color: white;
        }

        .priority-medium {
            background: #ff6f00;
            color: white;
        }

        .priority-low {
            background: #388e3c;
            color: white;
        }

        .issue-description {
            color: #333;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.02);
            border-radius: 8px;
        }

        .issue-meta {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            font-size: 0.9em;
            color: #666;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meta-item strong {
            color: #333;
        }

        .days-badge {
            background: #f5f5f5;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
        }

        .days-badge.critical {
            background: #ffcdd2;
            color: #c62828;
        }

        .days-badge.warning {
            background: #ffe0b2;
            color: #e65100;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.3em;
            color: #666;
        }

        .loading::after {
            content: "...";
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }

        .no-issues {
            background: white;
            padding: 60px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .no-issues h3 {
            color: #4caf50;
            font-size: 2em;
            margin-bottom: 15px;
        }

        .no-issues p {
            color: #666;
            font-size: 1.2em;
        }

        .error-message {
            background: #ffebee;
            border: 2px solid #ef5350;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }

        .error-message h3 {
            color: #c62828;
            margin-bottom: 10px;
        }

        .error-message p {
            color: #666;
        }

        .home-button {
            background: linear-gradient(145deg, #1976d2, #2196f3);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2em;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
            transition: all 0.3s ease;
            display: block;
            margin: 40px auto;
            text-decoration: none;
            text-align: center;
        }

        .home-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.6);
        }

        .filter-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
            justify-content: center;
        }

        .filter-btn {
            padding: 10px 25px;
            border: 2px solid #1976d2;
            background: white;
            color: #1976d2;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #1976d2;
            color: white;
        }

        .filter-btn.active {
            background: #1976d2;
            color: white;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .nav-back { left: 15px; }
            .arrow-btn { width: 38px; height: 38px; font-size: 1.1em; }
            .issue-card { padding: 20px; }
            .issue-header { flex-direction: column; }
            .stats-bar { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="nav-back">
                <a href="index.html" class="arrow-btn" title="Back to Home">‚óÑ</a>
            </div>
            <h1>üö® RECOGNIZED GAPS TRACKER</h1>
            <p class="subtitle">Persistent Challenges Requiring Attention</p>
        </header>

        <div class="info-banner">
            <h3>üìå Purpose of This Page</h3>
            <p>This tracker displays <strong>recurring hospital issues</strong> that have been reported multiple times without immediate resolution. Please review these ongoing challenges before submitting your daily reports to avoid redundant reporting. Issues are managed by the focal person and updated weekly.</p>
        </div>

        <div class="stats-bar" id="statsBar">
            <div class="stat-card">
                <div class="stat-number" id="totalIssues">0</div>
                <div class="stat-label">Total Issues</div>
            </div>
            <div class="stat-card high-priority">
                <div class="stat-number" id="highPriority">0</div>
                <div class="stat-label">High Priority</div>
            </div>
            <div class="stat-card medium-priority">
                <div class="stat-number" id="mediumPriority">0</div>
                <div class="stat-label">Medium Priority</div>
            </div>
            <div class="stat-card low-priority">
                <div class="stat-number" id="lowPriority">0</div>
                <div class="stat-label">Low Priority</div>
            </div>
        </div>

        <div class="filter-buttons" id="filterButtons">
            <button class="filter-btn active" onclick="filterIssues('all')">All Issues</button>
            <button class="filter-btn" onclick="filterIssues('admin')">Admin</button>
            <button class="filter-btn" onclick="filterIssues('clinical')">Clinical</button>
            <button class="filter-btn" onclick="filterIssues('nonclinical')">Non-Clinical</button>
            <button class="filter-btn" onclick="filterIssues('high')">High Priority</button>
        </div>

        <div id="issuesContainer" class="issues-grid">
            <div class="loading">Loading ongoing issues</div>
        </div>

        <a href="index.html" class="home-button">üè† BACK TO HOMEPAGE</a>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - UPDATE WITH YOUR SHEET ID
        // ============================================
        const ONGOING_ISSUES_SHEET_ID = '1G7gdPHlvFzAb2ileTDnpSb_6HE7npoUHTdoHR_mLcOw';

        let allIssues = [];
        let currentFilter = 'all';

        // Calculate days since an issue was reported
        function calculateDays(dateString) {
            // Handle multiple date formats
            let issueDate;
            
            // Try parsing as-is first (handles most formats)
            issueDate = new Date(dateString);
            
            // If invalid, try manual parsing for common formats
            if (isNaN(issueDate.getTime())) {
                // Try DD/MM/YYYY format
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    // Try MM/DD/YYYY
                    issueDate = new Date(parts[2], parts[0] - 1, parts[1]);
                    
                    // If still invalid, try DD/MM/YYYY
                    if (isNaN(issueDate.getTime())) {
                        issueDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                }
            }
            
            // If still invalid, try with dashes
            if (isNaN(issueDate.getTime()) && dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    issueDate = new Date(parts[0], parts[1] - 1, parts[2]);
                }
            }
            
            // If all parsing fails, return 0
            if (isNaN(issueDate.getTime())) {
                console.error('Could not parse date:', dateString);
                return 0;
            }
            
            const today = new Date();
            const diffTime = Math.abs(today - issueDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Get days badge class
        function getDaysBadgeClass(days) {
            if (days > 30) return 'critical';
            if (days > 14) return 'warning';
            return '';
        }

        // Fetch data from Google Sheet
        async function fetchIssuesData() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${ONGOING_ISSUES_SHEET_ID}/gviz/tq?tqx=out:json`;
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                return json.table.rows;
            } catch (error) {
                console.error('Error fetching issues data:', error);
                return null;
            }
        }

        // Process sheet data
        function processIssuesData(rows) {
            if (!rows || rows.length === 0) return [];

            const issues = [];
            // Skip header row, start from index 1
            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].c;
                if (!cells) continue;

                // Expected columns: Date Reported | Category | Priority | Issue Description
                const dateReported = cells[0]?.f || cells[0]?.v;
                const category = cells[1]?.v;
                const priority = cells[2]?.v;
                const description = cells[3]?.v;

                if (description && category && priority && dateReported) {
                    const days = calculateDays(dateReported);
                    
                    // Normalize category: handle "Admin", "Clinical", "Non-Clinical", etc.
                    // Removes hyphens, spaces, converts to lowercase
                    const normalizedCategory = category.toLowerCase().replace(/[-\s]/g, '');
                    
                    // Normalize priority: handle "High", "Medium", "Low" in any case
                    const normalizedPriority = priority.toLowerCase().trim();
                    
                    // Validate normalized values
                    const validCategories = ['admin', 'clinical', 'nonclinical'];
                    const validPriorities = ['high', 'medium', 'low'];
                    
                    if (validCategories.includes(normalizedCategory) && validPriorities.includes(normalizedPriority)) {
                        issues.push({
                            dateReported,
                            category: normalizedCategory,
                            priority: normalizedPriority,
                            description,
                            days
                        });
                    } else {
                        console.warn('Skipping invalid row:', {
                            category: category,
                            priority: priority,
                            normalizedCategory,
                            normalizedPriority
                        });
                    }
                }
            }
            return issues;
        }

        // Create issue card HTML
        function createIssueCard(issue) {
            const categoryIcons = {
                admin: 'üëî',
                clinical: '‚öïÔ∏è',
                nonclinical: 'üîß'
            };

            const priorityIcons = {
                high: 'üî¥',
                medium: 'üü°',
                low: 'üü¢'
            };

            const daysBadgeClass = getDaysBadgeClass(issue.days);
            const formattedDate = new Date(issue.dateReported).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });

            return `
                <div class="issue-card ${issue.priority}" data-category="${issue.category}" data-priority="${issue.priority}">
                    <div class="issue-header">
                        <span class="issue-category category-${issue.category}">
                            ${categoryIcons[issue.category]} ${issue.category.toUpperCase()}
                        </span>
                        <span class="priority-badge priority-${issue.priority}">
                            ${priorityIcons[issue.priority]} ${issue.priority.toUpperCase()}
                        </span>
                    </div>
                    <div class="issue-description">
                        ${issue.description}
                    </div>
                    <div class="issue-meta">
                        <div class="meta-item">
                            <span>üìÖ <strong>First Reported:</strong> ${formattedDate}</span>
                        </div>
                        <div class="meta-item">
                            <span>‚è±Ô∏è <strong>Days Outstanding:</strong> 
                                <span class="days-badge ${daysBadgeClass}">${issue.days} days</span>
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update statistics
        function updateStats(issues) {
            document.getElementById('totalIssues').textContent = issues.length;
            document.getElementById('highPriority').textContent = 
                issues.filter(i => i.priority === 'high').length;
            document.getElementById('mediumPriority').textContent = 
                issues.filter(i => i.priority === 'medium').length;
            document.getElementById('lowPriority').textContent = 
                issues.filter(i => i.priority === 'low').length;
        }

        // Filter issues
        function filterIssues(filter) {
            currentFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Filter and display
            let filtered = allIssues;
            if (filter !== 'all') {
                filtered = allIssues.filter(issue => 
                    issue.category === filter || issue.priority === filter
                );
            }

            displayIssues(filtered);
        }

        // Display issues
        function displayIssues(issues) {
            const container = document.getElementById('issuesContainer');
            
            if (issues.length === 0) {
                container.innerHTML = `
                    <div class="no-issues">
                        <h3>‚úÖ No Issues in This Category</h3>
                        <p>Great work! There are no ongoing issues matching this filter.</p>
                    </div>
                `;
                return;
            }

            // Sort by priority (high first) then by days (oldest first)
            const priorityOrder = { high: 1, medium: 2, low: 3 };
            issues.sort((a, b) => {
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return b.days - a.days;
            });

            container.innerHTML = issues.map(issue => createIssueCard(issue)).join('');
        }

        // Load all issues
        async function loadIssues() {
            const container = document.getElementById('issuesContainer');

            // Check if Sheet ID is configured
            if (!ONGOING_ISSUES_SHEET_ID || ONGOING_ISSUES_SHEET_ID === 'YOUR_ONGOING_ISSUES_SHEET_ID_HERE') {
                container.innerHTML = `
                    <div class="error-message">
                        <h3>‚öôÔ∏è Configuration Required</h3>
                        <p>Please update the ONGOING_ISSUES_SHEET_ID in the code with your Google Sheet ID.</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">See the setup instructions for details.</p>
                    </div>
                `;
                return;
            }

            try {
                const rows = await fetchIssuesData();
                
                if (rows === null) {
                    container.innerHTML = `
                        <div class="error-message">
                            <h3>‚ùå Error Loading Data</h3>
                            <p>Unable to fetch data from Google Sheet. Please check:</p>
                            <ul style="text-align: left; margin: 15px auto; max-width: 400px;">
                                <li>Sheet ID is correct</li>
                                <li>Sheet is published/publicly accessible</li>
                                <li>Internet connection is stable</li>
                            </ul>
                        </div>
                    `;
                    return;
                }

                allIssues = processIssuesData(rows);
                
                if (allIssues.length === 0) {
                    container.innerHTML = `
                        <div class="no-issues">
                            <h3>üéâ Excellent News!</h3>
                            <p>There are currently no ongoing issues to report. Keep up the great work!</p>
                        </div>
                    `;
                    updateStats([]);
                    return;
                }

                updateStats(allIssues);
                displayIssues(allIssues);

            } catch (error) {
                console.error('Error loading issues:', error);
                container.innerHTML = `
                    <div class="error-message">
                        <h3>‚ùå Unexpected Error</h3>
                        <p>An error occurred while loading the issues. Please refresh the page or contact support.</p>
                    </div>
                `;
            }
        }

        // Initialize
        loadIssues();
    </script>
</body>
</html>